{% extends "base.html" %}

{% block title %}Nueva Cotización - {{ super() }}{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 text-primary">
            <i class="bi bi-plus-circle"></i>
            Nueva Cotización
        </h1>
        <p class="text-muted">Crea una cotización paso a paso usando tu catálogo de productos (BOM)</p>
    </div>
    <div>
        <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i>
            Volver al Dashboard
        </a>
    </div>
</div>

<form id="quoteForm">
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-person"></i>
                Paso 1: Datos del Cliente
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="client_name" class="form-label">Nombre del Cliente *</label>
                    <input type="text" class="form-control" id="client_name" required
                           placeholder="Nombre completo del cliente">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="client_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="client_email"
                           placeholder="cliente@email.com">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="client_phone" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="client_phone"
                           placeholder="+52 999 123 4567">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="client_address" class="form-label">Dirección</label>
                    <input type="text" class="form-control" id="client_address"
                           placeholder="Dirección del proyecto">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-window"></i>
                Paso 2: Configurar Ventanas
                <small class="text-muted">(Selecciona productos de tu catálogo de BOM)</small>
            </h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addWindowItem()">
                <i class="bi bi-plus"></i>
                Agregar Ventana
            </button>
        </div>
        <div class="card-body">
            <div id="windowItems">
                </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-chat-text"></i>
                Paso 3: Notas Adicionales (Opcional)
            </h5>
        </div>
        <div class="card-body">
            <textarea class="form-control" id="notes" rows="3"
                      placeholder="Observaciones, especificaciones especiales, etc."></textarea>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-currency-dollar"></i>
                Paso 4: Ajustes Financieros
                <small class="text-muted">(Porcentajes sobre el subtotal, tasa de IVA y costo de Mano de Obra)</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="profit_margin" class="form-label">Margen de Utilidad (%)</label>
                    <input type="number" class="form-control" id="profit_margin" step="0.01" min="0" max="100" value="{{ '%.2f'|format(business_overhead.profit_margin * 100) }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="indirect_costs_rate" class="form-label">Gastos Indirectos (%)</label>
                    <input type="number" class="form-control" id="indirect_costs_rate" step="0.01" min="0" max="100" value="{{ '%.2f'|format(business_overhead.indirect_costs * 100) }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="tax_rate" class="form-label">Tasa de IVA (%)</label>
                    <input type="number" class="form-control" id="tax_rate" step="0.01" min="0" max="100" value="{{ '%.2f'|format(business_overhead.tax_rate * 100) }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="labor_rate_per_m2_override" class="form-label">Costo Mano de Obra por m² (Opcional)</label>
                    <input type="number" class="form-control" id="labor_rate_per_m2_override" step="0.01" min="0" placeholder="Ej: 50.00 (anula el costo por tipo de ventana)">
                    <small class="form-text text-muted">Si se deja vacío, se usará el costo de mano de obra asociado al tipo de ventana del producto BOM.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-info" onclick="previewQuote()">
                        <i class="bi bi-eye"></i>
                        Vista Previa
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-success btn-lg" onclick="calculateQuote()">
                        <i class="bi bi-calculator"></i>
                        Calcular Cotización
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success"></i>
                    Cotización Calculada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultContent">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="saveQuote()">
                    <i class="bi bi-save"></i>
                    Guardar Cotización
                </button>
            </div>
        </div>
    </div>
</div>

<template id="windowItemTemplate">
    <div class="window-item border rounded p-3 mb-3" style="position: relative;">
        <button type="button" class="btn btn-sm btn-outline-danger"
                style="position: absolute; top: 10px; right: 10px;"
                onclick="removeWindowItem(this)">
            <i class="bi bi-trash"></i>
        </button>

        <div class="row">
            <div class="col-md-12 mb-2">
                <h6 class="text-primary">Ventana <span class="window-number"></span></h6>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Tipo de Ventana *</label>
                <select class="form-select window-type-filter" onchange="filterProductsByWindowType(this)">
                    <option value="">Todos los tipos</option>
                    {# Populated by JavaScript #}
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Línea de Aluminio *</label>
                <select class="form-select aluminum-line-filter" onchange="filterProductsByAluminumLine(this)">
                    <option value="">Todas las líneas</option>
                    {# Populated by JavaScript #}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Producto de Ventana *</label> {# Updated Label #}
                <select class="form-select product-bom-id" required onchange="updateProductInfo(this)">
                    <option value="">Seleccionar Producto...</option>
                    {# Products will be populated by JavaScript after type and line selection #}
                </select>
            </div>

            <div class="col-md-2 mb-3">
                <label class="form-label">Cantidad *</label>
                <input type="number" class="form-control quantity" min="1" max="100" value="1" required>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Ancho (cm) *</label>
                <input type="number" class="form-control width" min="30" max="500" step="0.1" required oninput="validateDimensions(this)">
                <div class="invalid-feedback"></div>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Alto (cm) *</label>
                <input type="number" class="form-control height" min="30" max="500" step="0.1" required oninput="validateDimensions(this)">
                <div class="invalid-feedback"></div>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Tipo de Vidrio *</label>
                <select class="form-select selected-glass-type" data-field="glass_material_id" required>
                    <option value="">Seleccionar vidrio...</option>
                    {% for glass in glass_materials %}
                    <option value="{{ glass.id }}" data-cost="{{ glass.cost_per_unit }}">
                        {{ glass.name }} - ${{ "%.2f"|format(glass.cost_per_unit) }}/m²
                    </option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted">
                    <i class="bi bi-database"></i> Cargado dinámicamente desde Materials Catalog
                </small>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Color de Perfiles *</label>
                <select class="form-select selected-profile-color" required>
                    <option value="">Seleccionar color...</option>
                    {# Colors will be populated by JavaScript based on product selection #}
                </select>
                <div class="invalid-feedback">Selecciona un color para los perfiles</div>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Descripción del Ítem (opcional)</label>
                <input type="text" class="form-control description"
                       placeholder="Ej: Ventana de sala, recámara principal...">
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-12">
                <div class="alert alert-info product-info-display" style="display: none;">
                    <small>
                        <strong>Tipo:</strong> <span class="display-window-type">N/A</span> |
                        <strong>Línea:</strong> <span class="display-aluminum-line">N/A</span>
                        <br>
                        <strong>Rangos (cm):</strong> <span class="display-min-width">N/A</span>x<span class="display-min-height">N/A</span> a <span class="display-max-width">N/A</span>x<span class="display-max-height">N/A</span>
                    </small>
                </div>
            </div>
        </div>

        <div class="row mt-3 item-live-calculation-display" style="display: none;">
            <div class="col-12">
                <div class="card card-body bg-light">
                    <h6 class="mb-2 text-dark">Desglose en Vivo <span class="text-primary live-subtotal"></span></h6>
                    <small class="d-flex justify-content-between">
                        <span>Perfiles:</span> <span class="live-profiles-cost"></span>
                    </small>
                    <small class="d-flex justify-content-between">
                        <span>Vidrio:</span> <span class="live-glass-cost"></span>
                    </small>
                    <small class="d-flex justify-content-between">
                        <span>Herrajes:</span> <span class="live-hardware-cost"></span>
                    </small>
                    <small class="d-flex justify-content-between">
                        <span>Consumibles:</span> <span class="live-consumables-cost"></span>
                    </small>
                    <small class="d-flex justify-content-between">
                        <span>Mano de Obra:</span> <span class="live-labor-cost"></span>
                    </small>
                    <div class="border-top mt-2 pt-2 fw-bold d-flex justify-content-between">
                        <span>Subtotal Ítem:</span> <span class="live-item-subtotal-final"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    let windowItemCounter = 0;
    let currentQuoteResult = null;

    const appProducts = {{ app_products | tojson }}.map(p => ({
        ...p,
        min_width_cm: parseFloat(p.min_width_cm),
        max_width_cm: parseFloat(p.max_width_cm),
        min_height_cm: parseFloat(p.min_height_cm),
        max_height_cm: parseFloat(p.max_height_cm),
        bom: p.bom.map(item => ({
            ...item,
            waste_factor: parseFloat(item.waste_factor)
        }))
    }));
    const appMaterials = {{ app_materials | tojson }}.map(m => ({
        ...m,
        cost_per_unit: parseFloat(m.cost_per_unit),
        selling_unit_length_m: m.selling_unit_length_m ? parseFloat(m.selling_unit_length_m) : null
    }));

    const windowTypes = {{ window_types | tojson }};
    const aluminumLines = {{ aluminum_lines | tojson }};
    const glassTypes = {{ glass_types | tojson }};  // OLD PATH - deprecated
    const glassMaterials = {{ glass_materials | tojson }};  // NEW PATH - database-driven

    const appProductsMap = new Map(appProducts.map(p => [p.id, p]));
    const appMaterialsMap = new Map(appMaterials.map(m => [m.id, m]));
    const glassMaterialsMap = new Map(glassMaterials.map(g => [g.id, g]));

    window.addWindowItem = function() {
        const template = document.getElementById('windowItemTemplate');
        const clone = template.content.cloneNode(true);

        windowItemCounter++;
        clone.querySelector('.window-number').textContent = windowItemCounter;

        const windowTypeFilterSelect = clone.querySelector('.window-type-filter');
        const aluminumLineFilterSelect = clone.querySelector('.aluminum-line-filter');
        const productBomIdSelect = clone.querySelector('.product-bom-id');
        const quantityInput = clone.querySelector('.quantity');
        const widthInput = clone.querySelector('.width');
        const heightInput = clone.querySelector('.height');
        const selectedGlassTypeSelect = clone.querySelector('.selected-glass-type');
        const selectedProfileColorSelect = clone.querySelector('.selected-profile-color');

        windowTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.value;
            option.textContent = type.label;
            windowTypeFilterSelect.appendChild(option);
        });

        aluminumLines.forEach(line => {
            const option = document.createElement('option');
            option.value = line.value;
            option.textContent = line.label;
            aluminumLineFilterSelect.appendChild(option);
        });

        windowTypeFilterSelect.addEventListener('change', () => {
            window.filterProductsByAluminumLine(aluminumLineFilterSelect);
        });
        aluminumLineFilterSelect.addEventListener('change', () => {
            window.filterProductsByAluminumLine(aluminumLineFilterSelect);
        });

        document.getElementById('windowItems').appendChild(clone);
        updateWindowNumbers();
        window.filterProductsByAluminumLine(aluminumLineFilterSelect);

        // Event listeners for live calculation
        productBomIdSelect.addEventListener('change', () => updateItemLiveCalculation(productBomIdSelect.closest('.window-item')));
        quantityInput.addEventListener('input', () => updateItemLiveCalculation(quantityInput.closest('.window-item')));
        widthInput.addEventListener('input', () => updateItemLiveCalculation(widthInput.closest('.window-item')));
        heightInput.addEventListener('input', () => updateItemLiveCalculation(heightInput.closest('.window-item')));
        selectedGlassTypeSelect.addEventListener('change', () => updateItemLiveCalculation(selectedGlassTypeSelect.closest('.window-item')));
        selectedProfileColorSelect.addEventListener('change', () => updateItemLiveCalculation(selectedProfileColorSelect.closest('.window-item')));

        document.getElementById('labor_rate_per_m2_override').addEventListener('input', () => {
            document.querySelectorAll('.window-item').forEach(item => updateItemLiveCalculation(item));
        });
    }

    window.removeWindowItem = function(button) {
        const windowItem = button.closest('.window-item');
        windowItem.remove();
        updateWindowNumbers();
    }

    function updateWindowNumbers() {
        const items = document.querySelectorAll('.window-item');
        items.forEach((item, index) => {
            item.querySelector('.window-number').textContent = index + 1;
        });
    }

    function formatEnumString(enumString) {
        if (!enumString) return 'N/A';
        return enumString.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function getGlassMaterialName(materialId) {
        if (!materialId) return 'N/A';
        const material = glassMaterialsMap.get(materialId);
        return material ? material.name : 'Vidrio Desconocido';
    }

    window.filterProductsByWindowType = function(windowTypeSelectElement) {
        const windowItem = windowTypeSelectElement.closest('.window-item');
        const aluminumLineFilterSelect = windowItem.querySelector('.aluminum-line-filter');
        window.filterProductsByAluminumLine(aluminumLineFilterSelect);
    };

    window.filterProductsByAluminumLine = function(aluminumLineSelectElement) {
        const windowItem = aluminumLineSelectElement.closest('.window-item');
        const windowTypeFilterSelect = windowItem.querySelector('.window-type-filter');
        const productBomIdSelect = windowItem.querySelector('.product-bom-id');

        const selectedWindowType = windowTypeFilterSelect.value;
        const selectedAluminumLine = aluminumLineSelectElement.value;

        productBomIdSelect.innerHTML = '<option value="">Seleccionar Producto...</option>';

        appProducts.forEach(product => {
            const matchesWindowType = (selectedWindowType === '' || product.window_type === selectedWindowType);
            const matchesAluminumLine = (selectedAluminumLine === '' || product.aluminum_line === selectedAluminumLine);

            if (matchesWindowType && matchesAluminumLine) {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${formatEnumString(product.window_type)} - ${formatEnumString(product.aluminum_line)})`;
                productBomIdSelect.appendChild(option);
            }
        });

        window.updateProductInfo(productBomIdSelect);
    };

    window.updateProductInfo = function(selectElement) {
        const windowItem = selectElement.closest('.window-item');
        const productId = selectElement.value;
        const productInfoDisplay = windowItem.querySelector('.product-info-display');
        const widthInput = windowItem.querySelector('.width');
        const heightInput = windowItem.querySelector('.height');
        const descriptionInput = windowItem.querySelector('.description'); // Get description input
        const selectedGlassTypeSelect = windowItem.querySelector('.selected-glass-type'); // Get glass type select
        const selectedProfileColorSelect = windowItem.querySelector('.selected-profile-color'); // Get profile color select

        if (productId) {
            const product = appProductsMap.get(parseInt(productId));
            if (product) {
                windowItem.querySelector('.display-window-type').textContent = formatEnumString(product.window_type);
                windowItem.querySelector('.display-aluminum-line').textContent = formatEnumString(product.aluminum_line);
                windowItem.querySelector('.display-min-width').textContent = product.min_width_cm;
                windowItem.querySelector('.display-max-width').textContent = product.max_width_cm;
                windowItem.querySelector('.display-min-height').textContent = product.min_height_cm;
                windowItem.querySelector('.display-max-height').textContent = product.max_height_cm;

                productInfoDisplay.style.display = 'block';

                widthInput.min = product.min_width_cm;
                widthInput.max = product.max_width_cm;
                heightInput.min = product.min_height_cm;
                heightInput.max = product.max_height_cm;

                validateDimensions(widthInput);
                validateDimensions(heightInput);

                loadProfileColors(selectedProfileColorSelect, product);
                updateItemDescription(windowItem);
                updateItemLiveCalculation(windowItem);

            } else {
                productInfoDisplay.style.display = 'none';
                descriptionInput.value = '';
                clearProfileColors(selectedProfileColorSelect);
                updateItemLiveCalculation(windowItem, true);
            }
        } else {
            productInfoDisplay.style.display = 'none';
            widthInput.min = 30; widthInput.max = 500;
            heightInput.min = 30; heightInput.max = 500;
            validateDimensions(widthInput);
            validateDimensions(heightInput);
            descriptionInput.value = '';
            clearProfileColors(selectedProfileColorSelect);
            updateItemLiveCalculation(windowItem, true);
        }
    };

    // Function to load available colors for profiles
    async function loadProfileColors(colorSelect, product) {
        // Clear existing options
        colorSelect.innerHTML = '<option value="">Seleccionar color...</option>';
        
        if (!product || !product.id) {
            return;
        }

        try {
            // Fetch colors for the specific material in the product BOM
            // First, we need to get the materials used in this product and find profile materials
            const response = await fetch(`/api/materials/by-category`);
            if (!response.ok) {
                console.warn('Failed to fetch materials by category');
                return;
            }
            
            const data = await response.json();
            if (data.categories && data.categories.Perfiles) {
                // Get the first profile material that has colors (simplified approach)
                const profilesWithColors = data.categories.Perfiles.filter(m => m.has_colors && m.colors.length > 0);
                
                if (profilesWithColors.length > 0) {
                    const firstProfileWithColors = profilesWithColors[0];
                    
                    // Populate color options
                    firstProfileWithColors.colors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color.color_id;
                        option.textContent = `${color.color_name} - $${parseFloat(color.price_per_unit).toFixed(2)}`;
                        option.dataset.colorName = color.color_name;
                        option.dataset.pricePerUnit = color.price_per_unit;
                        colorSelect.appendChild(option);
                    });
                    
                    // Select the first color by default
                    if (firstProfileWithColors.colors.length > 0) {
                        colorSelect.value = firstProfileWithColors.colors[0].color_id;
                    }
                }
            }
        } catch (error) {
            console.warn('Error loading profile colors:', error);
        }
    }

    // Function to clear profile colors
    function clearProfileColors(colorSelect) {
        colorSelect.innerHTML = '<option value="">Seleccionar color...</option>';
    }

    function updateItemDescription(windowItem) {
        const productId = windowItem.querySelector('.product-bom-id').value;
        const descriptionInput = windowItem.querySelector('.description');

        if (!productId) {
            descriptionInput.value = '';
            return;
        }

        const product = appProductsMap.get(parseInt(productId));
        if (!product) {
            descriptionInput.value = '';
            return;
        }

        const windowType = formatEnumString(product.window_type);
        const aluminumLine = formatEnumString(product.aluminum_line);
        const productName = product.name;
        const glassType = formatEnumString(windowItem.querySelector('.selected-glass-type').value);
        const profileColorSelect = windowItem.querySelector('.selected-profile-color');
        const profileColor = profileColorSelect.selectedOptions[0]?.dataset.colorName || '';
        const width = windowItem.querySelector('.width').value;
        const height = windowItem.querySelector('.height').value;

        let description = `${windowType}, ${aluminumLine}, ${productName}`;
        if (profileColor) {
            description += `, Color: ${profileColor}`;
        }
        if (glassType && glassType !== 'Seleccionar...') {
            description += `, ${glassType}`;
        }
        if (width && height) {
            description += `, ${width}cm x ${height}cm`;
        }

        descriptionInput.value = description;
    }

    window.validateDimensions = function(inputElement) {
        const windowItem = inputElement.closest('.window-item');
        const productId = windowItem.querySelector('.product-bom-id').value;
        const value = parseFloat(inputElement.value);
        const feedbackDiv = inputElement.nextElementSibling;

        if (!productId) {
            if (value < 30 || value > 500) {
                inputElement.classList.add('is-invalid');
                feedbackDiv.textContent = `Dimensión debe ser entre 30 y 500 cm.`;
            } else {
                inputElement.classList.remove('is-invalid');
                feedbackDiv.textContent = '';
            }
            updateItemDescription(windowItem);
            updateItemLiveCalculation(windowItem);
            return;
        }

        const product = appProductsMap.get(parseInt(productId));
        if (!product) return;

        const min = parseFloat(inputElement.min);
        const max = parseFloat(inputElement.max);

        if (value < min || value > max) {
            inputElement.classList.add('is-invalid');
            feedbackDiv.textContent = `Dimensión debe ser entre ${min} y ${max} cm para este producto.`;
        } else {
            inputElement.classList.remove('is-invalid');
            feedbackDiv.textContent = '';
        }
        updateItemDescription(windowItem);
        updateItemLiveCalculation(windowItem);
    }

    async function updateItemLiveCalculation(windowItemElement, clearOnly = false) {
        const displayDiv = windowItemElement.querySelector('.item-live-calculation-display');
        const subtotalSpan = windowItemElement.querySelector('.live-item-subtotal-final');
        const profilesCostSpan = windowItemElement.querySelector('.live-profiles-cost');
        const glassCostSpan = windowItemElement.querySelector('.live-glass-cost');
        const hardwareCostSpan = windowItemElement.querySelector('.live-hardware-cost');
        const consumablesCostSpan = windowItemElement.querySelector('.live-consumables-cost');
        const laborCostSpan = windowItemElement.querySelector('.live-labor-cost');
        const liveSubtotalTitle = windowItemElement.querySelector('.live-subtotal');

        if (clearOnly) {
            displayDiv.style.display = 'none';
            subtotalSpan.textContent = '';
            profilesCostSpan.textContent = '';
            glassCostSpan.textContent = '';
            hardwareCostSpan.textContent = '';
            consumablesCostSpan.textContent = '';
            laborCostSpan.textContent = '';
            liveSubtotalTitle.textContent = '';
            return;
        }

        const productId = windowItemElement.querySelector('.product-bom-id').value;
        const width = parseFloat(windowItemElement.querySelector('.width').value);
        const height = parseFloat(windowItemElement.querySelector('.height').value);
        const quantity = parseInt(windowItemElement.querySelector('.quantity').value);
        const selectedGlassMaterialId = windowItemElement.querySelector('.selected-glass-type').value;  // NEW PATH: material ID
        const selectedProfileColor = windowItemElement.querySelector('.selected-profile-color').value;

        if (!productId || isNaN(width) || isNaN(height) || isNaN(quantity) || quantity <= 0 || !selectedGlassMaterialId || !selectedProfileColor) {
            displayDiv.style.display = 'none';
            return;
        }

        const product = appProductsMap.get(parseInt(productId));
        if (!product || width < product.min_width_cm || width > product.max_width_cm ||
                       height < product.min_height_cm || height > product.max_height_cm) {
            displayDiv.style.display = 'none';
            return;
        }

        displayDiv.style.display = 'block';
        liveSubtotalTitle.textContent = '(Calculando...)';

        try {
            const laborRateOverride = document.getElementById('labor_rate_per_m2_override').value;

            const itemData = {
                product_bom_id: parseInt(productId),
                selected_glass_material_id: selectedGlassMaterialId ? parseInt(selectedGlassMaterialId) : null,  // NEW PATH
                selected_glass_type: null,  // OLD PATH - deprecated
                selected_profile_color: selectedProfileColor,
                width_cm: width,
                height_cm: height,
                quantity: quantity,
                description: windowItemElement.querySelector('.description').value || null, // Ensure description is sent
                window_type: product.window_type,
                aluminum_line: product.aluminum_line,
                glass_type: product.glass_type
            };

            const queryParams = new URLSearchParams();
            if (laborRateOverride && !isNaN(parseFloat(laborRateOverride))) {
                queryParams.append('labor_rate_override', parseFloat(laborRateOverride));
            }
            
            const url = `/quotes/calculate_item?${queryParams.toString()}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(itemData)
            });

            if (response.ok) {
                const result = await response.json();
                profilesCostSpan.textContent = `$${parseFloat(result.total_profiles_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                glassCostSpan.textContent = `$${parseFloat(result.total_glass_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                hardwareCostSpan.textContent = `$${parseFloat(result.total_hardware_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                consumablesCostSpan.textContent = `$${parseFloat(result.total_consumables_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                laborCostSpan.textContent = `$${parseFloat(result.labor_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                subtotalSpan.textContent = `$${parseFloat(result.subtotal).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                liveSubtotalTitle.textContent = '(Listo)';

            } else {
                const error = await response.json();
                console.error('Full error object from API:', error);
                
                let errorMessage = 'Error desconocido';
                if (error && typeof error === 'object') {
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            errorMessage = error.detail.map(d => {
                                const loc = d.loc && Array.isArray(d.loc) ? d.loc.join('.') : 'unknown';
                                const inputInfo = (d.input !== null && d.input !== undefined) ? ` (Input: ${JSON.stringify(d.input)})` : '';
                                return `${loc}: ${d.msg}${inputInfo}`;
                            }).join('; ');
                        } else if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        } else {
                            errorMessage = JSON.stringify(error.detail);
                        }
                    } else if (error.message) {
                        errorMessage = error.message;
                    } else {
                        errorMessage = JSON.stringify(error);
                    }
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }
                showAlert('Error en cálculo de ítem: ' + errorMessage, 'danger');

                liveSubtotalTitle.textContent = '(Error)';
                subtotalSpan.textContent = 'N/A';
                profilesCostSpan.textContent = 'N/A';
                glassCostSpan.textContent = 'N/A';
                hardwareCostSpan.textContent = 'N/A';
                consumablesCostSpan.textContent = 'N/A';
                laborCostSpan.textContent = 'N/A';
            }
        } catch (error) {
            console.error('Network error or unexpected issue:', error);
            showAlert('Error de conexión al calcular ítem: ' + error.message, 'danger');
            liveSubtotalTitle.textContent = '(Error de red)';
            subtotalSpan.textContent = 'N/A';
            profilesCostSpan.textContent = 'N/A';
            glassCostSpan.textContent = 'N/A';
            hardwareCostSpan.textContent = 'N/A';
            consumablesCostSpan.textContent = 'N/A';
            laborCostSpan.textContent = 'N/A';
        }
    }

    window.previewQuote = function() {
        const quoteData = collectFormData();
        if (!validateQuoteData(quoteData)) return;

        let previewHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-person"></i> Cliente</h6>
                    <p><strong>${quoteData.client.name}</strong><br>
                    ${quoteData.client.email || ''}<br>
                    ${quoteData.client.phone || ''}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-window"></i> Resumen</h6>
                    <p>${quoteData.items.length} ventana(s) configurada(s)</p>
                </div>
            </div>
            <hr>
            <h6>Ventanas:</h6>
        `;

        quoteData.items.forEach((item, index) => {
            const product = appProductsMap.get(item.product_bom_id);
            const productName = product ? product.name : 'Producto Desconocido';

            previewHTML += `
                <div class="border rounded p-2 mb-2">
                    <strong>Ventana ${index + 1}:</strong> ${productName} -
                    ${item.width_cm}cm x ${item.height_cm}cm (${item.quantity} unidad(es))
                    <br><small class="text-muted">Vidrio: ${getGlassMaterialName(item.selected_glass_material_id)}</small>
                    ${item.description ? `<br><small class="text-primary">${item.description}</small>` : ''}
                </div>
            `;
        });

        previewHTML += `
            <hr>
            <h6>Ajustes Financieros:</h6>
            <ul class="list-unstyled">
                <li>Margen de Utilidad: ${parseFloat(document.getElementById('profit_margin').value)}%</li>
                <li>Gastos Indirectos: ${parseFloat(document.getElementById('indirect_costs_rate').value)}%</li>
                <li>Tasa de IVA: ${parseFloat(document.getElementById('tax_rate').value)}%</li>
                <li>Costo Mano de Obra por m² (Override): ${document.getElementById('labor_rate_per_m2_override').value !== '' ? '$' + parseFloat(document.getElementById('labor_rate_per_m2_override').value).toFixed(2) : 'Por Defecto'}</li>
            </ul>
        `;


        document.getElementById('resultContent').innerHTML = previewHTML;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

    window.calculateQuote = async function() {
        const quoteData = collectFormData();
        if (!validateQuoteData(quoteData)) return false;

        try {
            showAlert('Calculando cotización...', 'info');

            console.log('Datos que se envían:', quoteData);

            const response = await fetch('/quotes/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(quoteData)
            });

            if (response.ok) {
                const result = await response.json();
                currentQuoteResult = result;
                displayQuoteResult(result);
                showAlert('¡Cotización calculada exitosamente!', 'success');
            } else {
                const error = await response.json();
                showAlert('Error: ' + (error.detail || 'Error desconocido'), 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error de conexión: ' + error.message, 'danger');
        }

        return false;
    }

    function displayQuoteResult(result) {
        const resultHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h6><i class="bi bi-person"></i> Cliente: ${result.client.name}</h6>
                    <p class="small text-muted">Cotización #${result.quote_id} - ${new Date(result.calculated_at).toLocaleString()}</p>
                </div>
                <div class="col-md-4 text-end">
                    <h4 class="text-success">Total: $${parseFloat(result.total_final).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h4>
                </div>
            </div>

            <hr>

            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Ventana</th>
                            <th>Dimensiones</th>
                            <th>Área</th>
                            <th>Desglose Materiales</th>
                            <th>Mano Obra</th>
                            <th>Subtotal Item</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.items.map((item, index) => {
                            const productName = item.product_bom_name || 'Producto Desconocido';
                            return `
                            <tr>
                                <td>
                                    <strong>Ventana ${index + 1}: ${productName}</strong><br>
                                    <small class="text-muted">Tipo: ${formatEnumString(item.window_type)} | Línea: ${formatEnumString(item.aluminum_line)}</small>
                                    <br><small class="text-muted">Vidrio: ${getGlassMaterialName(item.selected_glass_material_id)}</small>
                                    ${item.description ? `<br><small class="text-primary">${item.description}</small>` : ''}
                                </td>
                                <td>
                                    ${item.width_cm}cm x ${item.height_cm}cm<br>
                                    <small class="text-muted">${item.quantity} unidad(es)</small>
                                </td>
                                <td>
                                    ${parseFloat(item.area_m2).toFixed(2)} m²<br>
                                    <small class="text-muted">${parseFloat(item.perimeter_m).toFixed(2)}m perímetro</small>
                                </td>
                                <td>
                                    <small>
                                        Perfiles: $${parseFloat(item.total_profiles_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
                                        Vidrio: $${parseFloat(item.total_glass_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
                                        Herrajes: $${parseFloat(item.total_hardware_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
                                        Consumibles: $${parseFloat(item.total_consumables_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </small>
                                </td>
                                <td>
                                    $${parseFloat(item.labor_cost).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </td>
                                <td>
                                    <strong>$${parseFloat(item.subtotal).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
                                </td>
                            </tr>
                        `;}).join('')}
                    </tbody>
                </table>
            </div>

            <hr>

            <div class="row">
                <div class="col-md-6">
                    <h6>Desglose de Costos:</h6>
                    <ul class="list-unstyled">
                        <li>Materiales (total): $${parseFloat(result.materials_subtotal).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                        <li>Mano de obra (total): $${parseFloat(result.labor_subtotal).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                        <li class="border-top pt-2"><strong>Subtotal antes de gastos: $${parseFloat(result.subtotal_before_overhead).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Gastos Generales:</h6>
                    <ul class="list-unstyled">
                        <li>Utilidad: $${parseFloat(result.profit_amount).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                        <li>Gastos indirectos: $${parseFloat(result.indirect_costs_amount).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                        <li>IVA: $${parseFloat(result.tax_amount).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                        <li class="border-top pt-2"><strong class="text-success">Total Final: $${parseFloat(result.total_final).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></li>
                    </ul>
                </div>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = resultHTML;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

    function collectFormData() {
        const items = [];
        let isValid = true;
        document.querySelectorAll('.window-item').forEach((item, index) => {
            const productId = parseInt(item.querySelector('.product-bom-id').value);
            const product = appProductsMap.get(productId);

            if (!product) {
                showAlert(`Producto no seleccionado para ventana ${index + 1}.`, 'warning');
                isValid = false;
                return;
            }

            // NEW PATH: Send glass material ID (database-driven)
            const glassSelect = item.querySelector('.selected-glass-type');
            const glassValue = glassSelect.value;

            const itemData = {
                product_bom_id: productId,
                selected_glass_material_id: glassValue ? parseInt(glassValue) : null,  // NEW PATH
                selected_glass_type: null,  // OLD PATH - deprecated, set to null
                selected_profile_color: item.querySelector('.selected-profile-color').value,

                width_cm: parseFloat(item.querySelector('.width').value) || 0,
                height_cm: parseFloat(item.querySelector('.height').value) || 0,
                quantity: parseInt(item.querySelector('.quantity').value) || 1,
                description: item.querySelector('.description').value || null,

                window_type: product.window_type,
                aluminum_line: product.aluminum_line,
                glass_type: product.glass_type
            };

            items.push(itemData);
        });

        if (!isValid) return null;

        return {
            client: {
                name: document.getElementById('client_name').value,
                email: document.getElementById('client_email').value || null,
                phone: document.getElementById('client_phone').value || null,
                address: document.getElementById('client_address').value || null
            },
            items: items,
            notes: document.getElementById('notes').value || null,
            profit_margin: parseFloat(document.getElementById('profit_margin').value) / 100 || null,
            indirect_costs_rate: parseFloat(document.getElementById('indirect_costs_rate').value) / 100 || null,
            tax_rate: parseFloat(document.getElementById('tax_rate').value) / 100 || null,
            labor_rate_per_m2_override: parseFloat(document.getElementById('labor_rate_per_m2_override').value) || null
        };
    }

    function validateQuoteData(data) {
        if (!data) return false;

        if (!data.client.name) {
            showAlert('Por favor ingresa el nombre del cliente', 'warning');
            return false;
        }

        if (data.items.length === 0) {
            showAlert('Debes agregar al menos una ventana', 'warning');
            return false;
        }

        for (let i = 0; i < data.items.length; i++) {
            const item = data.items[i];
            const windowItemElement = document.querySelectorAll('.window-item')[i];

            if (!item.product_bom_id) {
                showAlert(`Por favor selecciona un producto para la ventana ${i + 1}`, 'warning');
                return false;
            }
            // NEW PATH: Check for glass material ID instead of enum
            if (!item.selected_glass_material_id) {
                showAlert(`Por favor selecciona el tipo de vidrio para la ventana ${i + 1}`, 'warning');
                return false;
            }

            if (!item.width_cm || !item.height_cm || !item.quantity) {
                showAlert(`Por favor completa las dimensiones y cantidad de la ventana ${i + 1}`, 'warning');
                return false;
            }

            const product = appProductsMap.get(item.product_bom_id);
            if (product) {
                if (item.width_cm < product.min_width_cm || item.width_cm > product.max_width_cm ||
                    item.height_cm < product.min_height_cm || item.height_cm > product.max_height_cm) {
                    showAlert(`Las dimensiones (${item.width_cm}x${item.height_cm}cm) de la ventana ${i + 1} están fuera del rango permitido para el producto '${product.name}' (${product.min_width_cm}-${product.max_width_cm}cm x ${product.min_height_cm}-${product.max_height_cm}cm).`, 'warning');
                    windowItemElement.querySelector('.width').classList.add('is-invalid');
                    windowItemElement.querySelector('.height').classList.add('is-invalid');
                    return false;
                } else {
                    windowItemElement.querySelector('.width').classList.remove('is-invalid');
                    windowItemElement.querySelector('.height').classList.remove('is-invalid');
                }
            }
        }

        const profitMargin = parseFloat(document.getElementById('profit_margin').value);
        const indirectCostsRate = parseFloat(document.getElementById('indirect_costs_rate').value);
        const taxRate = parseFloat(document.getElementById('tax_rate').value);

        if (isNaN(profitMargin) || profitMargin < 0 || profitMargin > 100) {
            showAlert('Por favor, ingresa un Margen de Utilidad válido (0-100%).', 'warning');
            document.getElementById('profit_margin').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('profit_margin').classList.remove('is-invalid');
        }
        if (isNaN(indirectCostsRate) || indirectCostsRate < 0 || indirectCostsRate > 100) {
            showAlert('Por favor, ingresa una tasa de Gastos Indirectos válida (0-100%).', 'warning');
            document.getElementById('indirect_costs_rate').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('indirect_costs_rate').classList.remove('is-invalid');
        }
        if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
            showAlert('Por favor, ingresa una Tasa de IVA válida (0-100%).', 'warning');
            document.getElementById('tax_rate').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('tax_rate').classList.remove('is-invalid');
        }
        const laborRateOverride = document.getElementById('labor_rate_per_m2_override').value;
        if (laborRateOverride !== "") {
            const parsedLaborRate = parseFloat(laborRateOverride);
            if (isNaN(parsedLaborRate) || parsedLaborRate <= 0) {
                showAlert('Por favor, ingresa un Costo de Mano de Obra por m² válido y mayor que 0, o déjalo vacío.', 'warning');
                document.getElementById('labor_rate_per_m2_override').classList.add('is-invalid');
                return false;
            } else {
                document.getElementById('labor_rate_per_m2_override').classList.remove('is-invalid');
            }
        }

        return true;
    }

    window.saveQuote = function() {
        if (currentQuoteResult && currentQuoteResult.quote_id) {
            showAlert('Cotización guardada exitosamente', 'success');
            setTimeout(() => {
                window.location.href = `/quotes/${currentQuoteResult.quote_id}`;
            }, 1500);
        }
    }

    function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    document.addEventListener('DOMContentLoaded', function() {
        window.addWindowItem();

        document.getElementById('quoteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            return false;
        });
    });

})();
</script>
{% endblock %}